## Topic 6: Introduction to `choices_selected` from `teal.transform`

The `choices_selected` function from `teal.transform` is a powerful utility for managing variable selections in teal modules.
It provides a flexible way to specify choices and default selections for inputs, with support for both eager and delayed evaluation.

This topic will cover common scenarios app developers face when building teal applications from existing modules:
- Limiting variable choices in module inputs
- Providing choices without knowing the dataset structure upfront
- Adapting to different datasets dynamically

## Introduction to `choices_selected`

### Basic Usage

The `choices_selected` function creates an object that specifies both available choices and selected defaults for UI inputs.

```{r}
library(teal.transform)
library(pharmaverseadam)
# Basic choices_selected example
ADSL <- pharmaverseadam::adsl
choices_selected(variable_choices(ADSL), "SEX")

print(basic_choices)
```

### `teal` example with clinical module

Let's start with a basic teal application that uses `choices_selected`:

```{r}
#| eval: false
library(teal.modules.clinical)

# Create sample data
data <- teal_data() |>
  within({
    ADSL <- pharmaverseadam::adsl

    ADSL$ARM <- as.factor(ADSL$ARM)
    ADSL$ARMCD <- as.factor(ADSL$ARMCD)
    ADSL$SEX <- as.factor(ADSL$SEX)
    ADSL$RACE <- as.factor(ADSL$RACE)

    attr(ADSL$ARM, "label") <- "Actual Treatment Arm"
    attr(ADSL$ARMCD, "label") <- "Actual Treatment Arm Code"
    attr(ADSL$SEX, "label") <- "Sex"
    attr(ADSL$RACE, "label") <- "Race"
})

join_keys(data) <- default_cdisc_join_keys[names(data)]

# Basic application using choices_selected
app <- init(
  data = data,
  modules = modules(
    tm_t_summary(
      label = "Demographic Table",
      dataname = "ADSL",
      arm_var = choices_selected(c("ARM", "ARMCD"), "ARM"),
      add_total = TRUE,
      summarize_vars = choices_selected(
        c("SEX", "RACE", "BMRKR2", "EOSDY", "DCSREAS", "AGE"),
        selected = c("SEX", "RACE", "AGE")
      ),
      useNA = "ifany"
    )
  )
)

runApp(app)
```

## Using `variable_choices`

- `variable_choices` function allows you to dynamically select variables based on dataset characteristics.

```{r}
ADSL <- data[["ADSL"]]

factor_vars <- variable_choices(ADSL, subset = function(data) {
  idx <- vapply(data, is.factor, logical(1))
  names(data)[idx]
})

# Use with choices_selected
analysis_vars <- choices_selected(
  choices = factor_vars,
  selected = variable_choices(ADSL, subset = function(data) {
    names(data)[names(data) %in% c("SEX", "RACE")]
  })
)

print(analysis_vars)
```

### Eager evaluation vs. Delayed evaluation

The `variable_choices` function can be used in two modes:

- Eager evaluation computes choices immediately, allowing for inspecting the choices beforehand _(just as shown above)_.
- Delayed evaluation allows choices to be determined at runtime, which is useful when dataset structure isn't known beforehand _(see example below)_.

```{r}
factor_vars <- variable_choices("ADSL", subset = function(data) {
  colnames(data)[is.factor(data)]
})

# Use with choices_selected
analysis_vars <- choices_selected(
  choices = factor_vars,
  selected = variable_choices("ADSL", subset = function(data) {
    names(data)[names(data) %in% c("SEX", "RACE", "AGE")]
  })
)

print(analysis_vars)
```

#### Application with Dynamic Variable Selection

```{r}
#| eval: false

# Application that automatically finds numeric variables
app_dynamic <- init(
  data = data,
  modules = modules(
    tm_t_summary(
      label = "Demographic Table",
      dataname = "ADSL",
      arm_var = choices_selected(c("ARM", "ARMCD"), "ARM"),
      add_total = TRUE,
      summarize_vars = analysis_vars,
      useNA = "ifany"
    )
  )
)

runApp(app_dynamic)
```

### `teal` example with Kaplan-Meier module

Using Kaplan-Meier module from `teal.modules.clinical`

```{r}
data_km <- teal_data()
data_km <- within(data, {
  ADSL <- pharmaverseadam::adsl

  ADSL$ARM <- as.factor(ADSL$ARM)
  ADSL$ARMCD <- as.factor(ADSL$ARMCD)
  ADSL$SEX <- as.factor(ADSL$SEX)
  ADSL$RACE <- as.factor(ADSL$RACE)

  ADTTE <- pharmaverseadam::adtte_onco
  ADTTE$ARM <- as.factor(ADTTE$ARM)
  ADTTE$ARMCD <- as.factor(ADTTE$ARMCD)
  ADTTE$AVALU = as.factor("DAYS")
})
join_keys(data_km) <- default_cdisc_join_keys[names(data_km)]

arm_ref_comp <- list(
  ACTARMCD = list(
    ref = "Pbo",
    comp = c("Xan_Hi", "Xan_Lo")
  ),
  ARM = list(
    ref = "Placebo",
    comp = c("Xanomeline High Dose", "Xanomeline Low Dose")
  )
)
ADSL <- data_km[["ADSL"]]
ADTTE <- data_km[["ADTTE"]]

app <- init(
  data = data_km,
  modules = modules(
    tm_g_km(
      label = "Kaplan-Meier Plot",
      dataname = "ADTTE",
      arm_var = choices_selected(
        variable_choices("ADSL", c("ARM", "ARMCD", "ACTARMCD")),
        "ARM"
      ),
      paramcd = choices_selected(
        value_choices("ADTTE", "PARAMCD", "PARAM"),
        "OS"
      ),
      arm_ref_comp = arm_ref_comp,
      strata_var = choices_selected(
        variable_choices("ADSL", c("SEX", "RACE")),
        "RACE"
      ),
      facet_var = choices_selected(
        variable_choices(ADSL, c("SEX", "RACE")),
        NULL
      )
    )
  )
)
runApp(app)
```

## Exercise

Fill in the code below to create a teal application that uses `choices_selected` to limit the variable choices for a summary table module.

- `group_var` with Treatment variable,
- `y` with Analysis variable,
- `param` with Parameter of Interest


```{.r}
{{< include exercise_6.R >}}
```

## Summary

The `choices_selected` function provides powerful flexibility for managing variable selections in teal applications.
By combining it with `variable_choices` and understanding when to use eager vs. delayed evaluation, you can create robust applications that adapt to different datasets and provide users with appropriate choices.

Key takeaways:
- Use `variable_choices` with subset functions for dynamic filtering
- Delayed evaluation helps when dataset structure is unknown
- Smart defaults improve user experience across different datasets
