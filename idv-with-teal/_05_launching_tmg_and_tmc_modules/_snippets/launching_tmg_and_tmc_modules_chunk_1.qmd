library(teal)
library(teal.modules.general)
library(teal.data)
library(pharmaverseadam)

# Step 1: Load multiple ADaM datasets from pharmaverseadam
data("adsl", package = "pharmaverseadam")
data("adae", package = "pharmaverseadam")

# Step 2: Create comprehensive teal_data with real datasets
comprehensive_data <- teal_data()
comprehensive_data <- within(comprehensive_data, {
  # Use real ADSL dataset - contains all standard CDISC variables
  ADSL <- adsl

  # Use real ADAE dataset - contains adverse event data
  ADAE <- adae

  # The pharmaverseadam datasets include:
  # ADSL: USUBJID, AGE, AGEGR1, SEX, RACE, ARM, ACTARM,
  #       BMIBL, HEIGHTBL, WEIGHTBL, SAFFL, ITTFL, and more
  # ADAE: USUBJID, AEDECOD, AEBODSYS, AESEV, AESER,
  #       AEREL, AEACN, AESTDY, AEENDY, and more
})

# Step 3: Create application with multiple TMG modules using real variables
app <- teal::init(
  data = comprehensive_data,
  modules = teal::modules(
    # Data exploration modules
    tm_data_table(
      label = "ADSL Data Table",
      dataname = "ADSL"
    ),

    tm_data_table(
      label = "ADAE Data Table",
      dataname = "ADAE"
    ),

    tm_variable_browser(
      label = "Variable Browser",
      dataname = "ADSL"
    ),

    # Visualization modules using real pharmaverseadam variables
    tm_g_scatterplot(
      label = "Demographics Scatter Plot",
      dataname = "ADSL",
      x = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("AGE", "BMIBL", "HEIGHTBL", "WEIGHTBL")),
          selected = "AGE"
        )
      ),
      y = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("AGE", "BMIBL", "HEIGHTBL", "WEIGHTBL")),
          selected = "BMIBL"
        )
      ),
      color_by = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("SEX", "ARM", "ACTARM", "RACE", "AGEGR1")),
          selected = "ARM"
        )
      )
    ),

    tm_g_distribution(
      label = "Age Distribution",
      dataname = "ADSL",
      dist_var = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("AGE", "BMIBL", "HEIGHTBL", "WEIGHTBL")),
          selected = "AGE"
        )
      ),
      strata_var = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("SEX", "ARM", "ACTARM", "RACE", "AGEGR1")),
          selected = "ARM"
        )
      )
    ),

    # Summary and analysis modules
    tm_t_summary(
      label = "Demographics Summary",
      dataname = "ADSL",
      summarize_vars = data_extract_spec(
        dataname = "ADSL",
        select = select_spec(
          choices = variable_choices("ADSL", c("AGE", "BMIBL", "HEIGHTBL", "WEIGHTBL")),
          selected = c("AGE", "BMIBL"),
          multiple = TRUE
        )
      ),
      useNA = "ifany"
    )
  )
)

# Step 3: Launch the comprehensive application
if (interactive()) {
  shiny::shinyApp(app$ui, app$server)
}
