library(teal)
library(teal.modules.general)
library(teal.data)
library(pharmaverseadam)

# Step 1: Load multiple ADaM datasets
data("adsl", package = "pharmaverseadam")
data("adae", package = "pharmaverseadam")
data("adlb", package = "pharmaverseadam")

# Step 2: Create comprehensive clinical data object
clinical_study_data <- teal_data()
clinical_study_data <- within(clinical_study_data, {
  # Subject-level data
  ADSL <- adsl

  # Adverse events data
  ADAE <- adae

  # Laboratory data
  ADLB <- adlb
})

# Step 3: Create nested module structure
app <- teal::init(
  data = clinical_study_data,
  modules = teal::modules(

    # Top-level module group: Data Overview
    teal::modules(
      label = "ğŸ“Š Data Overview",

      tm_data_table(
        label = "Subject Data (ADSL)",
        dataname = "ADSL"
      ),

      tm_data_table(
        label = "Adverse Events (ADAE)",
        dataname = "ADAE"
      ),

      tm_data_table(
        label = "Laboratory Data (ADLB)",
        dataname = "ADLB"
      ),

      tm_variable_browser(
        label = "Variable Explorer",
        dataname = "ADSL"
      )
    ),

    # Top-level module group: Demographics Analysis
    teal::modules(
      label = "ğŸ‘¥ Demographics & Baseline",

      # Nested subgroup: Demographic Distributions
      teal::modules(
        label = "Demographic Distributions",

        tm_g_distribution(
          label = "Age Distribution",
          dataname = "ADSL",
          dist_var = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", "AGE"),
              selected = "AGE"
            )
          ),
          strata_var = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("ARM", "ACTARM", "SEX", "RACE")),
              selected = "ARM"
            )
          )
        ),

        tm_g_distribution(
          label = "BMI Distribution",
          dataname = "ADSL",
          dist_var = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", "BMIBL"),
              selected = "BMIBL"
            )
          ),
          strata_var = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("ARM", "ACTARM", "SEX")),
              selected = "ARM"
            )
          )
        )
      ),

      # Nested subgroup: Demographic Relationships
      teal::modules(
        label = "Demographic Relationships",

        tm_g_scatterplot(
          label = "Age vs BMI",
          dataname = "ADSL",
          x = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", "AGE"),
              selected = "AGE"
            )
          ),
          y = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", "BMIBL"),
              selected = "BMIBL"
            )
          ),
          color_by = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("ARM", "SEX", "RACE")),
              selected = "ARM"
            )
          )
        ),

        tm_g_association(
          label = "Categorical Associations",
          dataname = "ADSL",
          ref = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("ARM", "SEX", "RACE", "AGEGR1")),
              selected = "ARM"
            )
          ),
          vars = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("SEX", "RACE", "AGEGR1", "COUNTRY")),
              selected = c("SEX", "RACE"),
              multiple = TRUE
            )
          )
        )
      ),

      # Nested subgroup: Summary Tables
      teal::modules(
        label = "Demographic Summary Tables",

        tm_t_summary(
          label = "Demographics by Treatment",
          dataname = "ADSL",
          arm_var = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("ARM", "ACTARM")),
              selected = "ARM"
            )
          ),
          summarize_vars = data_extract_spec(
            dataname = "ADSL",
            select = select_spec(
              choices = variable_choices("ADSL", c("AGE", "BMIBL", "SEX", "RACE")),
              selected = c("AGE", "SEX"),
              multiple = TRUE
            )
          )
        )
      )
    ),

    # Top-level module group: Safety Analysis
    teal::modules(
      label = "âš ï¸ Safety Analysis",

      # Nested subgroup: AE Overview
      teal::modules(
        label = "Adverse Events Overview",

        tm_t_summary(
          label = "AE Summary by Treatment",
          dataname = "ADAE",
          arm_var = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", c("ARM", "ACTARM")),
              selected = "ARM"
            )
          ),
          summarize_vars = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", c("AEDECOD", "AESEV", "AESER")),
              selected = c("AEDECOD", "AESEV"),
              multiple = TRUE
            )
          )
        ),

        tm_g_distribution(
          label = "AE Severity Distribution",
          dataname = "ADAE",
          dist_var = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", "AESEV"),
              selected = "AESEV"
            )
          ),
          strata_var = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", c("ARM", "ACTARM", "SEX")),
              selected = "ARM"
            )
          )
        )
      ),

      # Nested subgroup: Specific AE Analysis
      teal::modules(
        label = "Detailed AE Analysis",

        tm_g_association(
          label = "AE-Treatment Association",
          dataname = "ADAE",
          ref = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", c("ARM", "ACTARM")),
              selected = "ARM"
            )
          ),
          vars = data_extract_spec(
            dataname = "ADAE",
            select = select_spec(
              choices = variable_choices("ADAE", c("AESEV", "AESER", "AEREL")),
              selected = c("AESEV", "AESER"),
              multiple = TRUE
            )
          )
        )
      )
    ),

    # Top-level module group: Laboratory Analysis
    teal::modules(
      label = "ğŸ§ª Laboratory Analysis",

      teal::modules(
        label = "Lab Values Overview",

        tm_g_distribution(
          label = "Lab Parameter Distribution",
          dataname = "ADLB",
          dist_var = data_extract_spec(
            dataname = "ADLB",
            select = select_spec(
              choices = variable_choices("ADLB", "AVAL"),
              selected = "AVAL"
            )
          ),
          strata_var = data_extract_spec(
            dataname = "ADLB",
            select = select_spec(
              choices = variable_choices("ADLB", c("ARM", "PARAMCD", "VISIT")),
              selected = "PARAMCD"
            )
          )
        ),

        tm_g_scatterplot(
          label = "Baseline vs Post-baseline",
          dataname = "ADLB",
          x = data_extract_spec(
            dataname = "ADLB",
            select = select_spec(
              choices = variable_choices("ADLB", "BASE"),
              selected = "BASE"
            )
          ),
          y = data_extract_spec(
            dataname = "ADLB",
            select = select_spec(
              choices = variable_choices("ADLB", "AVAL"),
              selected = "AVAL"
            )
          ),
          color_by = data_extract_spec(
            dataname = "ADLB",
            select = select_spec(
              choices = variable_choices("ADLB", c("ARM", "PARAMCD")),
              selected = "ARM"
            )
          )
        )
      )
    )
  )
)

# Step 4: Launch the comprehensive nested application
if (interactive()) {
  shiny::shinyApp(app$ui, app$server)
}
