library(teal)
library(teal.modules.general)
library(teal.data)

# Step 1: Create datasets with CDISC structure
create_cdisc_datasets <- function() {
  # ADSL with standard CDISC variables
  ADSL <- data.frame(
    STUDYID = rep("STUDY001", 30),
    USUBJID = paste0("SUBJ", sprintf("%03d", 1:30)),
    SUBJID = sprintf("%03d", 1:30),
    SITEID = sample(paste0("SITE", sprintf("%02d", 1:5)), 30, replace = TRUE),
    AGE = sample(18:80, 30, replace = TRUE),
    SEX = as.factor(sample(c("M", "F"), 30, replace = TRUE)),
    ARM = as.factor(sample(c("Placebo", "Treatment A", "Treatment B"), 30, replace = TRUE)),
    SAFFL = "Y"
  )

  # ADAE with additional sequence variable
  n_aes <- 90
  ADAE <- data.frame(
    STUDYID = rep("STUDY001", n_aes),
    USUBJID = sample(ADSL$USUBJID, n_aes, replace = TRUE),
    SUBJID = sample(ADSL$SUBJID, n_aes, replace = TRUE),
    SITEID = sample(ADSL$SITEID, n_aes, replace = TRUE),
    AESEQ = sequence(table(sample(ADSL$USUBJID, n_aes, replace = TRUE))),
    AEDECOD = sample(c("Headache", "Nausea", "Fatigue", "Dizziness"), n_aes, replace = TRUE),
    AESEV = as.factor(sample(c("MILD", "MODERATE", "SEVERE"), n_aes, replace = TRUE)),
    SAFFL = "Y"
  )

  # ADCM (Concomitant Medications) with different structure
  n_cms <- 60
  ADCM <- data.frame(
    STUDYID = rep("STUDY001", n_cms),
    USUBJID = sample(ADSL$USUBJID, n_cms, replace = TRUE),
    SUBJID = sample(ADSL$SUBJID, n_cms, replace = TRUE),
    CMSEQ = sequence(table(sample(ADSL$USUBJID, n_cms, replace = TRUE))),
    CMDECOD = sample(c("Aspirin", "Ibuprofen", "Acetaminophen"), n_cms, replace = TRUE),
    CMCLAS = sample(c("ANALGESICS", "ANTI-INFLAMMATORY"), n_cms, replace = TRUE),
    SAFFL = "Y"
  )

  return(list(ADSL = ADSL, ADAE = ADAE, ADCM = ADCM))
}

# Step 2: Create cdisc_data with automatic join keys
datasets <- create_cdisc_datasets()
auto_data <- cdisc_data(
  ADSL = datasets$ADSL,
  ADAE = datasets$ADAE,
  ADCM = datasets$ADCM
)

# View automatic join keys
cat("Automatic join keys:\n")
print(join_keys(auto_data))

# Step 3: Define custom join keys
# Let's say we want to use different joining variables or add additional relationships
custom_keys <- join_keys(
  # Primary keys for each dataset
  join_key("ADSL", "ADSL", c("STUDYID", "USUBJID")),
  join_key("ADAE", "ADAE", c("STUDYID", "USUBJID", "AESEQ")),
  join_key("ADCM", "ADCM", c("STUDYID", "USUBJID", "CMSEQ")),

  # Relationships between datasets
  join_key("ADSL", "ADAE", c("STUDYID", "USUBJID")),
  join_key("ADSL", "ADCM", c("STUDYID", "USUBJID")),

  # Custom: Allow direct relationship between ADAE and ADCM
  # This might be useful for analyzing AEs and concomitant medications together
  join_key("ADAE", "ADCM", c("STUDYID", "USUBJID"))
)

# Step 4: Create cdisc_data with custom join keys
custom_data <- cdisc_data(
  ADSL = datasets$ADSL,
  ADAE = datasets$ADAE,
  ADCM = datasets$ADCM
)

# Override the automatic join keys
join_keys(custom_data) <- custom_keys

# View the custom join keys
cat("\nCustom join keys:\n")
print(join_keys(custom_data))

# Step 5: Compare the difference in a teal application
app_with_custom_keys <- teal::init(
  data = custom_data,
  modules = teal::modules(
    tm_data_table(
      label = "ADSL Data",
      dataname = "ADSL"
    ),
    tm_data_table(
      label = "ADAE Data",
      dataname = "ADAE"
    ),
    tm_data_table(
      label = "ADCM Data",
      dataname = "ADCM"
    ),
    tm_variable_browser(
      label = "Variable Browser",
      dataname = "ADSL"
    )
  )
)

# Understanding the impact of custom join keys:
# 1. The filter panel will show all three datasets
# 2. Filtering ADSL will affect both ADAE and ADCM (as expected)
# 3. Filtering ADAE will also affect ADCM due to our custom relationship
# 4. This allows for more complex filtering scenarios

# Launch the app to see custom join keys in action
if (interactive()) {
  shiny::shinyApp(app_with_custom_keys$ui, app_with_custom_keys$server)
}
