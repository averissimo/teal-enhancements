# Create a complete example showing data flow
library(teal)
library(teal.modules.general)

# Step 1: Create data with clear relationships
demo_data <- cdisc_data()
demo_data <- within(demo_data, {
  ADSL <- data.frame(
    USUBJID = paste0("SUBJ", sprintf("%03d", 1:20)),
    AGE = c(25, 35, 45, 55, 65, 75, 30, 40, 50, 60,
            28, 38, 48, 58, 68, 32, 42, 52, 62, 72),
    SEX = as.factor(rep(c("M", "F"), 10)),
    ARM = as.factor(rep(c("Placebo", "Treatment"), each = 10)),
    SAFFL = "Y"
  )

  ADAE <- data.frame(
    USUBJID = rep(ADSL$USUBJID[1:15], each = 2),  # Only first 15 subjects have AEs
    AESEQ = rep(1:2, 15),
    AEDECOD = sample(c("Headache", "Nausea", "Fatigue"), 30, replace = TRUE),
    AESEV = as.factor(sample(c("MILD", "MODERATE"), 30, replace = TRUE))
  )
})

# Step 2: Create teal app to demonstrate data flow
app <- teal::init(
  data = demo_data,
  modules = teal::modules(
    tm_data_table(
      label = "ADSL Data",
      dataname = "ADSL"
    ),
    tm_data_table(
      label = "ADAE Data",
      dataname = "ADAE"
    )
  )
)

# Understanding what happens when filters are applied:
# When you filter ADSL for:
# - AGE >= 50 (reduces ADSL from 20 to 10 subjects)
# - SEX == "M" (further reduces to 5 subjects)
#
# The ADAE dataset automatically gets filtered to only show
# adverse events for those 5 remaining subjects
# This happens because of the join keys: USUBJID

# Launch the app to see data flow in action
if (interactive()) {
  shiny::shinyApp(app$ui, app$server)
}
