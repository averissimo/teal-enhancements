# More explicit approach with within()
clinical_data <- cdisc_data()

clinical_data <- within(clinical_data, {
  # Create ADSL
  ADSL <- data.frame(
    STUDYID = rep("STUDY001", 100),
    USUBJID = paste0("SUBJ", sprintf("%03d", 1:100)),
    AGE = sample(18:80, 100, replace = TRUE),
    SEX = as.factor(sample(c("M", "F"), 100, replace = TRUE)),
    ARM = as.factor(sample(c("Placebo", "Treatment"), 100, replace = TRUE)),
    SAFFL = "Y"
  )

  # Create ADAE based on ADSL
  n_events <- 300
  ADAE <- data.frame(
    STUDYID = "STUDY001",
    USUBJID = sample(ADSL$USUBJID, n_events, replace = TRUE),
    AESEQ = sequence(table(sample(ADSL$USUBJID, n_events, replace = TRUE))),
    AEDECOD = sample(c("Headache", "Nausea", "Fatigue"), n_events, replace = TRUE),
    AESEV = as.factor(sample(c("MILD", "MODERATE", "SEVERE"), n_events, replace = TRUE))
  )
})

# View the structure and join keys
print(clinical_data)
join_keys(clinical_data)
