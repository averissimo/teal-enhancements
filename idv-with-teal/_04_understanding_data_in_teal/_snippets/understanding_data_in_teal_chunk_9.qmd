# Step 1: Create the datasets
cdisc_example <- teal_data()

cdisc_example <- within(cdisc_example, {
  # ADSL: Subject-Level Analysis Dataset
  ADSL <- data.frame(
    STUDYID = rep("STUDY001", 100),
    USUBJID = paste0("SUBJ", sprintf("%03d", 1:100)),
    SUBJID = sprintf("%03d", 1:100),
    SITEID = sample(paste0("SITE", sprintf("%02d", 1:10)), 100, replace = TRUE),
    AGE = sample(18:80, 100, replace = TRUE),
    AGEGR1 = cut(sample(18:80, 100, replace = TRUE),
                 breaks = c(0, 30, 50, 65, 100),
                 labels = c("<30", "30-50", "50-65", ">65")),
    SEX = as.factor(sample(c("M", "F"), 100, replace = TRUE)),
    RACE = as.factor(sample(c("WHITE", "BLACK", "ASIAN", "OTHER"), 100, replace = TRUE)),
    ARM = as.factor(sample(c("Placebo", "Treatment A", "Treatment B"), 100, replace = TRUE)),
    ACTARM = as.factor(sample(c("Placebo", "Treatment A", "Treatment B"), 100, replace = TRUE)),
    SAFFL = "Y",
    ITTFL = "Y"
  )

  # ADAE: Adverse Event Analysis Dataset
  # Generate realistic number of AEs per subject
  ae_counts <- rpois(100, 2.5)  # Average 2.5 AEs per subject
  total_aes <- sum(ae_counts)

  ADAE <- data.frame(
    STUDYID = rep("STUDY001", total_aes),
    USUBJID = rep(ADSL$USUBJID, ae_counts),
    SUBJID = rep(ADSL$SUBJID, ae_counts),
    SITEID = rep(ADSL$SITEID, ae_counts),
    AESEQ = sequence(ae_counts),
    AEDECOD = sample(c("Headache", "Nausea", "Fatigue", "Dizziness", "Insomnia",
                       "Diarrhea", "Constipation", "Rash", "Cough", "Fever"),
                     total_aes, replace = TRUE),
    AEBODSYS = sample(c("Nervous system disorders", "Gastrointestinal disorders",
                        "General disorders", "Skin and subcutaneous tissue disorders",
                        "Respiratory disorders"), total_aes, replace = TRUE),
    AESEV = as.factor(sample(c("MILD", "MODERATE", "SEVERE"), total_aes,
                            replace = TRUE, prob = c(0.6, 0.3, 0.1))),
    AESER = as.factor(sample(c("Y", "N"), total_aes, replace = TRUE, prob = c(0.05, 0.95))),
    AEREL = as.factor(sample(c("RELATED", "NOT RELATED", "POSSIBLY RELATED"),
                            total_aes, replace = TRUE, prob = c(0.2, 0.6, 0.2))),
    AEACN = as.factor(sample(c("NONE", "DOSE REDUCED", "DRUG WITHDRAWN"),
                            total_aes, replace = TRUE, prob = c(0.8, 0.15, 0.05))),
    AESTDY = sample(1:365, total_aes, replace = TRUE),
    SAFFL = "Y"
  )
})

# Step 2: Understand the automatic join keys
cat("Automatic CDISC join keys:\n")
print(join_keys(cdisc_example))

# Step 3: Verify the relationships work
cat("\nTesting the relationship:\n")
cat("ADSL subjects:", length(unique(cdisc_example[["ADSL"]]$USUBJID)), "\n")
cat("ADAE subjects:", length(unique(cdisc_example[["ADAE"]]$USUBJID)), "\n")
cat("ADAE events:", nrow(cdisc_example[["ADAE"]]), "\n")

# Step 4: Manual verification of join key validity
adsl_keys <- unique(cdisc_example[["ADSL"]][c("STUDYID", "USUBJID")])
adae_keys <- unique(cdisc_example[["ADAE"]][c("STUDYID", "USUBJID")])
cat("All ADAE subjects exist in ADSL:", all(adae_keys$USUBJID %in% adsl_keys$USUBJID), "\n")
