# Create application with initial filter state
initial_filters <- teal_slices(
  # Population definition filters
  teal_slice(
    dataname = "ADSL",
    varname = "ITTFL",
    selected = "Y",
    title = "Intent-to-Treat Population"
  ),
  teal_slice(
    dataname = "ADSL",
    varname = "ARM",
    selected = c("Placebo", "Xanomeline High Dose"),
    title = "Primary Analysis Arms"
  ),

  # Demographic filters
  teal_slice(
    dataname = "ADSL",
    varname = "AGE",
    selected = c(18, 80),
    title = "Adult Population"
  ),

  # Safety filters for ADAE
  teal_slice(
    dataname = "ADAE",
    varname = "AESEV",
    selected = c("MODERATE", "SEVERE"),
    title = "Moderate to Severe AEs"
  ),
  teal_slice(
    dataname = "ADAE",
    varname = "AEREL",
    selected = c("RELATED", "POSSIBLY RELATED"),
    title = "Treatment-Related AEs"
  )
)

# Launch application with predefined analysis focus
predefined_app <- teal::init(
  data = demo_data,
  modules = teal::modules(
    # Demographics analysis with predefined population
    teal::modules(
      label = "ðŸ“Š Demographics Analysis",
      tm_t_summary(
        label = "Baseline Demographics",
        dataname = "ADSL",
        summarize_vars = data_extract_spec(
          dataname = "ADSL",
          select = select_spec(
            choices = variable_choices("ADSL", c("AGE", "SEX", "RACE", "BMIBL")),
            selected = c("AGE", "SEX", "RACE"),
            multiple = TRUE
          )
        )
      ),
      tm_g_distribution(
        label = "Age Distribution by Treatment",
        dataname = "ADSL",
        dist_var = data_extract_spec(
          dataname = "ADSL",
          select = select_spec(
            choices = variable_choices("ADSL", "AGE"),
            selected = "AGE"
          )
        ),
        strata_var = data_extract_spec(
          dataname = "ADSL",
          select = select_spec(
            choices = variable_choices("ADSL", "ARM"),
            selected = "ARM"
          )
        )
      )
    ),

    # Safety analysis with predefined AE filters
    teal::modules(
      label = "âš ï¸ Safety Analysis",
      tm_data_table(
        label = "Treatment-Related AEs",
        dataname = "ADAE"
      ),
      tm_g_distribution(
        label = "AE Severity Distribution",
        dataname = "ADAE",
        dist_var = data_extract_spec(
          dataname = "ADAE",
          select = select_spec(
            choices = variable_choices("ADAE", "AESEV"),
            selected = "AESEV"
          )
        ),
        strata_var = data_extract_spec(
          dataname = "ADAE",
          select = select_spec(
            choices = variable_choices("ADAE", "ARM"),
            selected = "ARM"
          )
        )
      )
    )
  ),
  filter = initial_filters,  # Apply predefined filters
  title = "Clinical Study Analysis - Predefined Population"
)

# This application launches with:
# - Only ITT population subjects
# - Only primary analysis treatment arms
# - Only adult subjects (18-80 years)
# - Only moderate to severe, treatment-related AEs
# - All analyses automatically focus on this defined population

if (interactive()) {
  shiny::shinyApp(predefined_app$ui, predefined_app$server)
}
