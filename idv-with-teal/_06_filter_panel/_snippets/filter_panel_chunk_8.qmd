# Create data with clear relationships to demonstrate coupling
coupled_demo_data <- teal_data()
coupled_demo_data <- within(coupled_demo_data, {
  # ADSL - 20 subjects for clear demonstration
  ADSL <- adsl[1:20, ]

  # ADAE - Only adverse events for first 15 subjects
  ADAE <- adae[adae$USUBJID %in% ADSL$USUBJID[1:15], ]

  # ADCM - Only concomitant meds for first 10 subjects
  ADCM <- data.frame(
    STUDYID = "01-701-1015",
    USUBJID = rep(ADSL$USUBJID[1:10], each = 2),
    CMSEQ = rep(1:2, 10),
    CMDECOD = sample(c("ASPIRIN", "IBUPROFEN", "ACETAMINOPHEN"), 20, replace = TRUE),
    CMSTDTC = sample(seq.Date(as.Date("2013-01-01"), as.Date("2013-12-31"), by = "day"), 20)
  )
})

# Application demonstrating coupled filtering
coupled_app <- teal::init(
  data = coupled_demo_data,
  modules = teal::modules(
    tm_data_table(
      label = "ADSL (Subject Level)",
      dataname = "ADSL"
    ),
    tm_data_table(
      label = "ADAE (Adverse Events)",
      dataname = "ADAE"
    ),
    tm_data_table(
      label = "ADCM (Concomitant Meds)",
      dataname = "ADCM"
    ),
    tm_variable_browser(
      label = "Data Summary",
      dataname = "ADSL"
    )
  )
)

# Coupled filtering behavior:
# 1. Filter ADSL by ARM = "Placebo" (affects ~7 subjects)
# 2. ADAE automatically filters to show only AEs for those 7 subjects
# 3. ADCM automatically filters to show only meds for those subjects
# 4. All modules update simultaneously with consistent data

if (interactive()) {
  shiny::shinyApp(coupled_app$ui, coupled_app$server)
}
